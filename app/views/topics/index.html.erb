<div class="topics container">
  <div class="row">
    <h2>Health Topics</h2>
  </div>

  <div class="row">
    <div class="action-header">

      <div class="actions mobile col-xs-12 text-center">
        <%= link_to "Add Topic", new_patient_topic_path, class: "btn btn-default" %>
        <br>
        <%= link_to "Full Log", patient_path(@patient), class: "btn btn-default" %>
      </div>

      <div class="search col-xs-12 col-md-6">
        <%= form_tag patient_topics_path, method: :get, class: "search-form" do %>
          <%= text_field_tag :query,
            params[:query],
            class: "form-control",
            placeholder: "Find a topic by category, name or code"
          %>
          <%= button_tag(type: 'submit', class: "btn btn-search") do %>
            <i class="fas fa-search"></i>
          <% end %>
        <% end %>
      </div>

      <div class="actions website col-xs-12 col-md-4 col-md-offset-2">
        <%= link_to "Add Topic", new_patient_topic_path, class: "btn btn-default" %>
        <br>
        <%= link_to "Full Log", patient_path(@patient), class: "btn btn-default" %>
      </div>
    </div>
  </div>

  <div class="topic-container">

    <div class="header-row">
      <div class="row">
        <ul>
          <li class="col col-md-3">Category / Topic</li>
          <li class="col col-md-3">Last Update</li>
          <li class="col col-md-2">Status</li>
          <li class="col col-md-4">Info</li>
        </ul>
      </div>
    </div>

      <% @topics.each do |topic| %>
        <% first_update = topic.updates.first %>
        <% last_update = topic.updates.last %>

        <div class="topic-show">
          <ul class="topic-row row">
            <li class="topic-title col col-xs-12 col-sm-6 col-md-3">
              <%= image_tag("category_icons/#{topic.category.icon_url}", size: "48x48", alt: "#{topic.category.subject.capitalize}") %>
              <p><strong><%= topic.title %></strong>
              <span class="small">(<%= topic.subcode %>)</span></p>
            </li>

            <li class="topic-doctor col col-xs-6 col-sm-2 col-md-3">
              <%= image_tag(last_update.user.photo, class: "avatar-md", alt: "Dr. #{last_update.user.first_name} #{last_update.user.last_name}") %>
              <div class="update website">
                <p><%= "Dr. #{last_update.user.first_name} #{last_update.user.last_name}" %></p>
                <span class="small"><%= last_update.created_at.strftime("%d-%m-%Y") %></span>
              </div>
            </li>

            <% case last_update.topic_status %>
            <% when 'diagnosed' %>
              <% status_class = 'diagnosed' %>
            <% when 'under treatment' %>
              <% status_class = 'under_treatment' %>
            <% else %>
              <% status_class = 'cured' %>
            <% end %>

            <li class="topic-laststatus col-xs-6 col-sm-2 col-md-2">
              <div class="signal <%= status_class %>">
                <p class="<%= status_class %> website"><%= last_update.topic_status.capitalize %></p>
              </div>
            </li>

            <li class="topic-info col col-xs-12 col-sm-3 col-md-4">

              <%= link_to patient_topic_path(@patient, topic), class: "btn btn-default" do %>
                <i class="fas fa-list-ul"></i><span> <%= topic.updates.count %></span><span class="website"> Entries</span>
              <% end %>

              <%= link_to patient_documents_path(@patient), class: "btn btn-default" do %>
                <i class="far fa-file-alt"></i><span> <%= topic.documents.where(status: 'active').count - topic.documents.where(status: 'active', doc_type: 'Exam').count %></span><span class="website"> Documents</span>
              <% end %>

              <%= link_to patient_documents_path(@patient), class: "btn btn-default" do %>
                <i class="far fa-chart-bar"></i><span> <%= topic.documents.where(status: 'active', doc_type: 'Exam').count %></span><span class="website"> Exams</span>
              <% end %>

              <%= link_to patient_documents_path(@patient), class: "btn btn-default" do %>
                <i class="far fa-calendar-alt"></i><span> <%= topic.schedules.where(status: 'active').count %></span><span class="website"> Prescriptions</span>
              <% end %>

            </li>

          </ul>

          <ul class="topic-hidden">
            <li class="topic-lastupdate col col-1">
              <p><strong><%= last_update.created_at.strftime("%Y-%m-%d") %>:</strong> <%= last_update.diagnosis %></p>
            </li>
          </ul>
        </div>

      <% end %>
    </div>
  </div>
</div>
